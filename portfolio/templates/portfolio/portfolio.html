<!DOCTYPE html>
{% extends 'base.html' %}
{% block content %}
{% load static %}
    <main>

        <form id="new_img_form" class="hero card" action="{% url 'portfolio' %} " method="POST" enctype="multipart/form-data" style="display: none">
            <div>Здесь приделал форму из формы джанго, с возможностью настраивать стили для лейблов и полей </div>
            {% csrf_token %}
            <input id="edit_mode" type="text" name="edit_mode" >
            

            {% for field in form %}
            <div class="my_field">
                <label class="my_label" for="{{ field.auto_id }}">{{ field.label }}</label>
                {{ field }}
            </div>
            {% endfor %}

            <button id="submitButton" class="button" type = "submit">Добавить</button>
        </form>
        </section>
    {% if portfolio %}
        <section class="gallery">
        <div id="img_view">
<!--            Это основная картинка с описанием-->
            <img id="main-image" src="" alt="">
            <div id="descriptions">
                <div id="img_title">Название: <span>nazv</span></div>
                <div id="img_desc">Описание: <span>opis</span></div>
                <div id="img_date">Дата: <span>dat</span></div>
                <div id="img_urls">В сотрудничестве: <span>ssilki</span></div>
                <div id="img_id" hidden="hidden">ID: <span>id</span></div>
            </div>
        </div>
        <ul class="thumbs">
        {% for artwork in portfolio %}
<!--            <div class="card">-->
                <li class="thumb__block" href="{{ artwork.url }}">
                    <img class="thumb__img" src="{{ artwork.thumb.url }}" alt="">

                    <span class="tmb_title">{{ artwork.title }}</span>
                    <span class="tmb_desc" hidden="hidden">{{ artwork.desc }}</span>
                    <span class="tmb_date" hidden="hidden">{{ artwork.date }}</span>
                    <span class="tmb_urls" hidden="hidden">{{ artwork.url }}</span>
                    <span class="tmb_id" hidden="hidden">{{ artwork.id }}</span>
<!--                <span class="thumb__txt">{{ artwork.desc|truncatechars:20 }}</span>-->
                </li>
        {% endfor %}
        </ul>
        {% endif %}
        </section>







        <script>
            /**
            Просмотр галереи
            Описание кода в проядке следования:
            Метод getImgPath нужен чтобы удалить из пути к миниатюре подкаталог tmb. тогда получится путь к основной картинке.
            Из описания метода следует что в миниатюры попадают уменьшенные картинки, апри выборе картинки она подгружается
            с сервера. По крайней мере такова задумка - экономия времени и трафика...
            Соответственно при получении картинки на сервере будет создаватья thumb...
            Метод get_date преобразует дату из какого то формата в русскоязычную
            Хотелось бы обойтись без него, но что то преобразует дату из sql в англоязычную строку, которую обратно потом
            не запихнуть, а значит, придется делать обратное форматирование, а раз такое дело, то не важно что форматировать
            по этому преобразую эту непонятную строку в русскую, а при редактировании инфо на сервере уже она
            преобразуется в формат даты для сохранения...
            Далее идет сама галерея. Код добывает поля картинки и миниатюр..При тыке на миниатюру происходит подгрузка нужной
            картинки, но без тыка должна подгрузиться картинка по умолчанию (первая)
            по этому код до обработчика занят этим и сбором нужных переменных, которые могут использоваться не только в
            галереи, но и в коде добавления, редактирования и удаления... может нужно добавить независимости каждому блоку
            но ножны ли эти функции без самой галереи?
            Блоки добавления, редактирования и удаления добавляют соответствующие кнопки в хедер. Решение временное,
            но нужно было кудато их добавить, что бы можно было поработать с функционалом
            Форма отправки имеет два скрытых поля - id картинки и режим отправки - редактирование,удаление, или новое
            сервер по ним понимает что нужно сделать
            */
            function getImgPath(path) {
                const pathParts = path.split('/');
                const filteredPathParts = pathParts.filter(part => part !== 'tmb');
                return filteredPathParts.join('/');
                }


            function get_date(date)
            {
                let day_list = ['первое', 'второе', 'третье', 'четвёртое',
                    'пятое', 'шестое', 'седьмое', 'восьмое',
                    'девятое', 'десятое', 'одиннадцатое', 'двенадцатое',
                    'тринадцатое', 'четырнадцатое', 'пятнадцатое', 'шестнадцатое',
                    'семнадцатое', 'восемнадцатое', 'девятнадцатое', 'двадцатое',
                    'двадцать первое', 'двадцать второе', 'двадцать третье',
                    'двадацать четвёртое', 'двадцать пятое', 'двадцать шестое',
                    'двадцать седьмое', 'двадцать восьмое', 'двадцать девятое',
                    'тридцатое', 'тридцать первое'];
                let month_list = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                    'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];


                const months = {
                    'Jan.': 'января',
                    'Feb.': 'февраля',
                    "March":'марта',
                    "April":'апреля',
                    "May":'мая',
                    "June":'июня',
                    "July":'июля',
                    "Aug.":'августа',
                    "Sept.":'сентября',
                    "Oct.":'октября',
                    "Nov.":'ноября',
                    "Dec.":'декабря'
                };


                console.log(date)
                let date_list = date.split(',')
                let year = parseInt(date_list[1])
                console.log(year)
                let day_and_month = date_list[0].split(' ')
                let day = parseInt(day_and_month[1])
                console.log(day)
                let month = day_and_month[0]
                console.log(month)

                return (day_list[day - 1] + ' ' +
                    months[month] + ' ' +
                    year + ' года')

            }
            /**Блок галереи*/
            const mainView = document.getElementById('img_view');
            // if (thumbs){
                const mainBlock = mainView.children;
                const mainImage=mainBlock.namedItem('main-image');
                // mainImage.hidden="hidden"

                const mainDescription = mainBlock.namedItem('descriptions').children;
                const mainImage_title=mainDescription.namedItem('img_title').children.item(0);
                const mainImage_desc=mainDescription.namedItem('img_desc').children.item(0);
                const mainImage_date=mainDescription.namedItem('img_date').children.item(0);
                const mainImage_urls=mainDescription.namedItem('img_urls').children.item(0);

                const mainImage_id=mainDescription.namedItem('img_id').children.item(0);



                const thumbBlocks = document.querySelectorAll('.thumb__block');
                const firstThumbBlockContent = thumbBlocks[0];
                const thumbnail = firstThumbBlockContent.getElementsByTagName('img')[0]
                const descriptions = firstThumbBlockContent.getElementsByTagName('span');

                const title = descriptions[0];
                const desc = descriptions[1];
                const date = descriptions[2];
                const urls = descriptions[3];
                const img_id = descriptions[4];

                mainImage.src = getImgPath(thumbnail.src);
                mainImage.alt = thumbnail.alt;

                // mainView.style.backgroundImage=`url(${getImgPath(thumbnail.src)})`;
                // mainView.style.backgroundSize= 'contain';
                // mainView.style.backgroundRepeat= 'no-repeat';
                // mainView.style.width = 'auto';


                mainImage_title.textContent = title.textContent;
                mainImage_desc.textContent = desc.textContent;
                mainImage_date.textContent = get_date(date.textContent);
                mainImage_urls.textContent = urls.textContent;

                mainImage_id.textContent = img_id.textContent;

                thumbnail.classList.toggle('active');
                let old_active=thumbnail;


                    thumbBlocks.forEach(thumbBlock =>
                    {


                        thumbBlock.addEventListener('click', (event) =>
                        {
                            const target = event.target;
                            if (target.tagName === 'IMG')
                            {
                                // thumbBlock.classList.toggle('active', target === thumbBlock.firstElementChild);
                                target.classList.toggle('active');
                                old_active.classList.toggle('active');
                                old_active = target;
                            }


                            const image = thumbBlock.getElementsByTagName('img')[0];
                            const descriptions = thumbBlock.getElementsByTagName('span');
                            const title = descriptions[0];
                            const desc = descriptions[1];
                            const date = descriptions[2];
                            const urls = descriptions[3];
                            const img_id = descriptions[4];
                            mainImage.src = getImgPath(image.src);
                            mainImage.alt = image.alt;

                            mainView.style.backgroundImage=`url(${getImgPath(image.src)})`;
                            // mainView.style.backgroundSize= 'cover';
                            // mainView.style.backgroundRepeat= 'no-repeat';


                            mainImage_title.textContent = title.textContent;
                            mainImage_desc.textContent = desc.textContent;
                            mainImage_date.textContent=get_date(date.textContent);
                            mainImage_urls.textContent=urls.textContent;
                            mainImage_id.textContent=img_id.textContent;
                        });
                    });
            // }
        </script>
        <script>
            /**Блок добавления новой картинки*/
            const imgEditMode = document.getElementById('edit_mode');
            const newImgForm = document.getElementById('new_img_form');
            const textFields = newImgForm.getElementsByClassName('txt-input');
            const idField = textFields.namedItem('id');
            const imageField = document.getElementById('img_file');
            const titleField = textFields.namedItem('title');
            const descField = textFields.namedItem('desc');
            const dateField = textFields.namedItem('date');
            const urlsField = textFields.namedItem('url');

            const submitBtn = document.getElementById("submitButton");
            // imageField.required=false;
            // titleField.required=false;



            let header = document.getElementsByClassName('header-right')[0];
            const button = document.createElement('button');
            button.innerHTML = 'Добавить';
            header.appendChild(button);
            button.addEventListener("click", () =>
            {

                imgEditMode.value="new_image";
                imgEditMode.required=true;
                imageField.required=true;
                titleField.required=true;
                idField.required=false;
                descField.required=false;
                dateField.required=false;
                urlsField.required=false;

                imageField.value="";
                titleField.value="";
                descField.value="";
                dateField.value="";
                urlsField.value="";
                idField.value="";
                if (newImgForm.style.display === 'none')
                {
                    newImgForm.style.display='flex';
                    newImgForm.style.zIndex='var(--max-z-index)';
                    submitBtn.innerHTML="Отправить"
                }
                else
                {
                  newImgForm.style.display='none';
                  newImgForm.style.zIndex='-1';
                }
            });
        </script>
        <script>
            /**Блок редактирования картинки*/
            // const editImgForm = document.getElementById('new_img_form');
            // let header = document.getElementsByClassName('header-right')[0];
            let editbutton = document.createElement('button');

            editbutton.innerHTML = 'Редактировать';
            header.appendChild(editbutton);
            editbutton.addEventListener("click", () =>
            {
                imgEditMode.value="edit_image";
                imageField.required=false;
                titleField.required=true;
                idField.required=true;
                descField.required=false;
                dateField.required=false;
                urlsField.required=false;

                titleField.value=mainImage_title.textContent;
                descField.value=mainImage_desc.textContent;
                dateField.value=mainImage_date.textContent;
                urlsField.value=mainImage_urls.textContent;
                idField.value=mainImage_id.textContent;



                if (newImgForm.style.display === 'none')
                {
                    newImgForm.style.display='flex';
                    newImgForm.style.zIndex='var(--max-z-index)';
                    submitBtn.innerHTML="Сохранить"


                }
                else
                {
                  newImgForm.style.display='none';
                  newImgForm.style.zIndex='-1';
                }

            });
        </script>
        <script>
            /**Блок удаления картинки*/
            const deletebutton = document.createElement('button');

            deletebutton.innerHTML = 'Удалить';
            header.appendChild(deletebutton);
            deletebutton.addEventListener("click", () =>
            {
                imageField.required=false;
                titleField.required=false;
                idField.required=true;
                descField.required=false;
                dateField.required=false;
                urlsField.required=false;
                imgEditMode.value="delete_image";
                submitBtn.innerHTML="Удалить"
                idField.value=mainImage_id.textContent;
                submitBtn.click();
            });
            // submitBtn.ontouchend();
        </script>
    </main>
{% endblock %}
